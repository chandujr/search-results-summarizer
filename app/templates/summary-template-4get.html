<div id="summary-container" class="summary-container">
  <div class="summary-header">
    <div class="summary-title">
      <svg class="summary-icon" viewBox="0 0 24 24">
        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z" />
      </svg>
      <h3>Search Results Summary</h3>
    </div>
    <div id="show-summary-button-container" class="show-summary-container">
      <button id="show-summary-btn" class="show-summary-btn">Show Summary</button>
    </div>
  </div>
  <div id="summary-container-content" class="summary-content-container">
    <div id="summary-content-wrapper" class="summary-content-wrapper">
      <div id="summary-content" class="summary-content">
        <div class="loading-indicator">
          <div class="spinner"></div>
          <span>Generating summary...</span>
        </div>
      </div>
      <div id="summary-fade-overlay" class="summary-fade-overlay"></div>
    </div>
    <div id="summary-expand-btn" class="summary-expand-btn-container">
      <button id="toggle-summary" class="toggle-summary-btn">Show more</button>
    </div>
    <div class="powered-by">Powered by {{MODEL_NAME}} via {{PROVIDER_NAME}}</div>
    <div class="disclaimer">AI summaries may be inaccurate. Caution advised.</div>
  </div>
</div>

<style>
  .summary-container {
    background: var(--282828);
    border: 1px solid var(--504945);
    padding: 12px;
    margin: 15px 0;
    border-radius: 2px;
  }

  .summary-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .summary-title {
    display: flex;
    align-items: center;
  }

  .summary-icon {
    width: 20px;
    height: 20px;
    margin-right: 10px;
    fill: var(--8ec07c);
  }

  .summary-title h3 {
    margin: 0;
    color: var(--bdae93);
    font-size: 16px;
    font-weight: normal;
    line-height: normal;
  }

  .show-summary-container {
    display: none;
  }

  .show-summary-btn {
    background: none;
    border: 1px solid var(--8ec07c);
    color: var(--8ec07c);
    padding: 6px 12px;
    border-radius: 2px;
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    line-height: normal;
  }

  .summary-content-container {
    display: none;
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px solid var(--8ec07c);
  }

  .summary-content-wrapper {
    position: relative;
  }

  .summary-content {
    color: var(--a89984);
    line-height: 22px;
    font-size: 16px;
    min-height: 60px;
    max-height: 200px;
    overflow: hidden;
    transition: max-height 0.3s ease;
  }

  .loading-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    color: var(--928374);
  }

  .loading-indicator span {
    padding-top: 8px;
  }

  .spinner {
    width: 16px;
    height: 16px;
    border: 2px solid var(--504945);
    border-top-color: var(--8ec07c);
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }

  .summary-fade-overlay {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 40px;
    background: linear-gradient(to bottom, transparent, var(--282828));
    pointer-events: none;
    display: none;
    z-index: 1;
  }

  .summary-expand-btn-container {
    display: none;
    text-align: center;
    /* Remove blue highlight */
    -webkit-tap-highlight-color: transparent;
    -webkit-touch-callout: none;
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
    user-select: none;
    outline: none;
    -webkit-focus-ring-color: transparent;
  }

  .toggle-summary-btn {
    width: 100%;
    background: none;
    border: 1px solid var(--8ec07c);
    color: var(--8ec07c);
    padding: 6px 12px;
    border-radius: 2px;
    cursor: pointer;
    font-size: 14px;
    line-height: normal;
  }

  .powered-by {
    padding-top: 8px;
    font-size: 11px;
    color: var(--928374);
    border-top: 1px solid var(--504945);
  }

  .disclaimer {
    font-size: 10px;
    color: var(--928374);
    line-height: 1.4;
  }

  .error-message {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #fc92a5;
  }

  .error-icon {
    width: 16px;
    height: 16px;
    fill: #fc92a5;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }

  /* Code block styling */
  .summary-content pre {
    background-color: var(--1d2021);
    border: 1px solid var(--504945);
    border-radius: 3px;
    padding: 12px;
    margin: 10px 0;
    overflow-x: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .summary-content code {
    background-color: var(--3c3836);
    border-radius: 3px;
    padding: 2px 4px;
    font-family: monospace;
    font-size: 0.9em;
    color: var(--ebdbb2);
  }

  .summary-content pre code {
    background-color: transparent;
    padding: 0;
    font-size: 0.9em;
  }

  /* Other markdown elements */
  .summary-content blockquote {
    border-left: 3px solid var(--8ec07c);
    margin: 10px 0;
    padding-left: 15px;
    color: var(--928374);
    font-style: italic;
  }

  .summary-content ul,
  .summary-content ol {
    margin: 10px 0;
    padding-left: 25px;
  }

  .summary-content li {
    margin: 5px 0;
  }

  .summary-content p {
    margin: 10px 0;
  }

  .summary-content a {
    color: var(--8ec07c);
  }

  /* Table styling to fix 4get layout issues */
  .summary-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 15px 0;
    font-size: 14px;
    table-layout: auto;
  }

  .summary-content th,
  .summary-content td {
    border: 1px solid var(--504945);
    padding: 8px 12px !important;
    text-align: center;
    color: var(--a89984);
    width: auto !important;
    vertical-align: middle !important;
    white-space: normal !important;
    word-wrap: break-word !important;
  }

  .summary-content th {
    background-color: var(--3c3836);
    color: var(--bdae93);
    line-height: normal;
  }

  .summary-content tr:nth-child(even) {
    background-color: rgba(56, 52, 54, 0.3);
  }

  /* Table wrapper for horizontal scrolling */
  .summary-content .table-wrapper {
    overflow-x: auto;
    width: 100%;
    margin: 15px 0;
    -webkit-overflow-scrolling: touch;
  }

  /* Override 4get's responsive table styles */
  @media (max-width: 1000px) {
    .summary-content .table-wrapper table {
      min-width: 600px;
      display: table !important;
    }

    .summary-content .table-wrapper table th,
    .summary-content .table-wrapper table td {
      display: table-cell !important;
      width: auto !important;
    }
  }
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.css" />
<script src="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.js"></script>
<script src="/js/template-utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.6/dist/purify.min.js"></script>
<script>
  (function() {
    // DOM elements
    const container = document.getElementById('summary-content');
    const expandBtnContainer = document.getElementById('summary-expand-btn');
    const toggleBtn = document.getElementById('toggle-summary');
    const showSummaryBtnContainer = document.getElementById('show-summary-button-container');
    const showSummaryBtn = document.getElementById('show-summary-btn');
    const query = {{QUERY_JSON}};
    const results = {{RESULTS_JSON}};
    const isManualMode = {{IS_MANUAL_MODE}};

    // State
    let isExpanded = false;
    const maxHeight = 200; // Maximum height in pixels before showing "Show more"
    let summaryText = '';

    // Request deduplication - prevent multiple simultaneous requests for same query
    const requestKey = `${query}_${results.length}`; // Create unique key based on query and result count
    if (window.summaryRequestCache && window.summaryRequestCache[requestKey]) {
      console.log('[Search Results Summary] Request already in progress for this query');
      return;
    }

    // Initialize request cache if it doesn't exist
    if (!window.summaryRequestCache) {
      window.summaryRequestCache = {};
    }

    // Mark this request as in progress
    window.summaryRequestCache[requestKey] = true;

    const converter = new showdown.Converter({
      parseImgDimensions: true,
      simplifiedAutoLink: true,
      strikethrough: true,
      tables: true,
      tasklists: true,
      ghCodeBlocks: true,
      ghMentions: true,
      ghMentionsLink: 'https://github.com/{u}',
      smoothLivePreview: true,
      smartIndentationFix: true,
      emoji: true,
      underline: true,
      ellipsis: true,
      completeHTMLDocument: false,
      metadata: false,
      splitAdjacentBlockquotes: false,
      noHeaderId: true,
      prefixHeaderId: false
    });

    function showError(message) {
      container.innerHTML = `
        <div class="error-message">
          <svg class="error-icon" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
          </svg>
          <span>${message}</span>
        </div>
      `;
    }

    // Function to handle expand/collapse
    function toggleExpand() {
      isExpanded = !isExpanded;
      const fadeOverlay = document.getElementById('summary-fade-overlay');

      if (isExpanded) {
        container.style.maxHeight = 'none';
        toggleBtn.textContent = 'Show less';
        fadeOverlay.style.display = 'none';
      } else {
        container.style.maxHeight = maxHeight + 'px';
        toggleBtn.textContent = 'Show more';
        // Show the fade overlay when content is collapsed
        if (container.scrollHeight > maxHeight) {
          fadeOverlay.style.display = 'block';
        }
        container.scrollIntoView({ behavior: 'auto', block: 'start' });
      }
    }

    function showSummary() {
      setSummaryContainerUI(true);
      fetchSummary().finally(() => {
        // Clear request cache when done (whether success or error)
        if (window.summaryRequestCache) {
          delete window.summaryRequestCache[requestKey];
        }
      });
    }

    function setSummaryContainerUI(visible) {
      const summaryContainerContent = document.getElementById('summary-container-content');
      if(visible) {
        showSummaryBtnContainer.style.display = 'none';
        container.style.display = 'block';
        summaryContainerContent.style.display = 'block';
      } else {
        showSummaryBtnContainer.style.display = 'block';
        container.style.display = 'none';
        summaryContainerContent.style.display = 'none';
      }
    }

    showSummaryBtn.addEventListener('click', showSummary);

    // Function to check and update expand button visibility
    function checkExpandButton() {
      if (!isExpanded && container.scrollHeight > maxHeight) {
        expandBtnContainer.style.display = 'block';
        document.getElementById('summary-fade-overlay').style.display = 'block';
      }
    }

    // Function to process a chunk of streaming data
    function processChunk(data) {
      if (data.error) {
        console.error('[Search Results Summary] Error:', data.error);
        showError(data.error);
        return true; // Signal to stop processing
      }

      if (data.done) {
        console.log('[Search Results Summary] Complete');
        return true; // Signal to stop processing
      }

      if (data.content) {
        summaryText += data.content;

        const sanitizedHTML = TemplateUtils.processMarkdownWithLatexAndCodeBlocks(
          summaryText,
          converter,
          DOMPurify.sanitize
        );

        container.innerHTML = sanitizedHTML;

        // Wrap tables in a div for horizontal scrolling on small screens
        const tables = container.querySelectorAll('table');
        tables.forEach(table => {
          if (!table.parentNode.classList.contains('table-wrapper')) {
            const wrapper = document.createElement('div');
            wrapper.className = 'table-wrapper';
            table.parentNode.insertBefore(wrapper, table);
            wrapper.appendChild(table);
          }
        });

        checkExpandButton();
      }
      return false; // Continue processing
    }

    toggleBtn.addEventListener('click', toggleExpand);

    // Function to handle streaming response
    async function processStream(response) {
      const reader = response.body.getReader();
      const decoder = new TextDecoder();
      let buffer = '';

      function readStream() {
        return reader.read().then(({ done, value }) => {
          if (done) {
            console.log('[Search Results Summary] Stream completed');
            return;
          }

          buffer += decoder.decode(value, { stream: true });

          // Process all complete JSON objects in the buffer
          let newlineIndex;
          while ((newlineIndex = buffer.indexOf('\n')) !== -1) {
            const line = buffer.substring(0, newlineIndex);
            buffer = buffer.substring(newlineIndex + 1);

            if (line.trim() === '') continue;

            try {
              const data = JSON.parse(line);

              // Process the chunk and stop if it returns true
              if (processChunk(data)) {
                return;
              }
            } catch (e) {
              console.error('[Search Results Summary] Parse error:', e, 'Line:', line);
            }
          }

          return readStream();
        });
      }

      return readStream().catch(error => {
        console.error('[Search Results Summary] Stream reading error:', error);
        showError('Connection error: ' + error.message);
      });
    }

    // Main function to fetch and process the summary
    async function fetchSummary() {
      console.log('[Search Results Summary] Starting fetch stream');
      try {
        const response = await fetch(window.location.origin + '/api/summary', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ query, results })
        });

        // Handle rate limit errors specifically
        if (response.status === 429) {
          const data = await response.json();
          showError(data.error || 'Rate limit exceeded. Please try again later.');
          return;
        }

        if (!response.ok) {
          throw new Error('Network response was not ok');
        }

        return processStream(response);
      } catch (error) {
        console.error('[Search Results Summary] Fetch error:', error);
        showError('Connection error: ' + error.message);
      }
    }

    // Initialize UI based on mode
    if (isManualMode) {
      setSummaryContainerUI(false);
    } else {
      setSummaryContainerUI(true);
      // In auto mode, fetch the summary immediately
      fetchSummary().finally(() => {
        // Clear request cache when done (whether success or error)
        if (window.summaryRequestCache) {
          delete window.summaryRequestCache[requestKey];
        }
      });
    }
  })();
</script>
